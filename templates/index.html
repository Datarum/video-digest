<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VideoDigest â€” YouTube è§†é¢‘æ€»ç»“</title>
<style>
:root {
  --bg: #f1f5f9;
  --surface: #ffffff;
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #eef2ff;
  --success: #22c55e;
  --success-light: #f0fdf4;
  --warning: #f59e0b;
  --warning-light: #fffbeb;
  --error: #ef4444;
  --error-light: #fef2f2;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --radius: 14px;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.05);
  --shadow-lg: 0 8px 24px rgba(0,0,0,.10);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 24px 16px 64px;
}

.container { max-width: 800px; margin: 0 auto; }

header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 28px;
}
header .logo {
  width: 40px; height: 40px;
  background: var(--primary);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
}
header h1 { font-size: 22px; font-weight: 700; }
header p  { font-size: 13px; color: var(--text-muted); margin-top: 2px; }

.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 16px;
}

.form-group { margin-bottom: 16px; }
label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }

input[type="text"], input[type="password"], select {
  width: 100%;
  padding: 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 15px;
  color: var(--text);
  background: var(--surface);
  transition: border-color .15s;
  outline: none;
}
input[type="text"]:focus,
input[type="password"]:focus,
select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,.12); }

.url-input { font-size: 16px; padding: 12px 14px; }

.row { display: flex; gap: 12px; }
.row .form-group { flex: 1; }

.hint { font-size: 12px; color: var(--text-muted); margin-top: 5px; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 11px 24px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn:active { transform: scale(.98); }
.btn-primary {
  background: var(--primary);
  color: #fff;
  width: 100%;
  font-size: 16px;
  padding: 13px;
}
.btn-primary:hover { background: var(--primary-dark); }
.btn-primary:disabled { opacity: .55; cursor: not-allowed; transform: none; }

#progress-section { display: none; }

.steps { display: flex; flex-direction: column; gap: 0; }

.step {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
  opacity: .4;
  transition: opacity .2s;
}
.step:last-child { border-bottom: none; }
.step.active, .step.done, .step.warn, .step.skip, .step.error { opacity: 1; }

.step-icon {
  width: 28px; height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  flex-shrink: 0;
  transition: background .2s, border-color .2s;
}
.step.active .step-icon  { border-color: var(--primary); background: var(--primary-light); color: var(--primary); animation: pulse 1.2s infinite; }
.step.done  .step-icon   { border-color: var(--success); background: var(--success-light); color: var(--success); }
.step.warn  .step-icon   { border-color: var(--warning); background: var(--warning-light); color: var(--warning); }
.step.skip  .step-icon   { border-color: var(--border);  background: var(--bg); color: var(--text-muted); }
.step.error .step-icon   { border-color: var(--error);   background: var(--error-light);   color: var(--error); }

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,.4); }
  50%       { box-shadow: 0 0 0 5px rgba(99,102,241,.0); }
}

.step-body { flex: 1; min-width: 0; }
.step-name { font-size: 14px; font-weight: 600; }
.step-msg  { font-size: 13px; color: var(--text-muted); margin-top: 2px; word-break: break-word; }

#result-section { display: none; }

.video-header {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}
.video-thumb {
  width: 140px; height: 79px;
  border-radius: 8px;
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg);
}
.video-meta { flex: 1; min-width: 0; }
.video-title { font-size: 17px; font-weight: 700; line-height: 1.3; margin-bottom: 6px; }
.video-info  { font-size: 13px; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 10px; }
.video-info a { color: var(--primary); text-decoration: none; }
.video-info a:hover { text-decoration: underline; }

.section-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.overview-text { font-size: 15px; line-height: 1.7; color: var(--text); }

.key-points { list-style: none; display: flex; flex-direction: column; gap: 8px; }
.key-points li {
  display: flex; gap: 10px; align-items: flex-start;
  font-size: 14px; line-height: 1.5;
}
.key-points li::before {
  content: "";
  display: block;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--primary);
  flex-shrink: 0;
  margin-top: 6px;
}

.chapters { display: flex; flex-direction: column; gap: 16px; }

.chapter-card {
  border: 1.5px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  gap: 0;
}
.chapter-frame {
  width: 140px;
  flex-shrink: 0;
  background: var(--bg);
  position: relative;
  overflow: hidden;
}
.chapter-frame img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.chapter-frame .no-frame {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
  color: var(--border);
  min-height: 80px;
}
.chapter-body { flex: 1; padding: 14px 16px; min-width: 0; }
.chapter-ts {
  font-size: 11px; font-weight: 700;
  color: var(--primary);
  background: var(--primary-light);
  padding: 2px 8px; border-radius: 20px;
  display: inline-block;
  margin-bottom: 6px;
}
.chapter-title { font-size: 15px; font-weight: 700; margin-bottom: 5px; }
.chapter-summary { font-size: 13px; color: var(--text-muted); line-height: 1.6; }

.action-bar {
  display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;
}
.btn-outline {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--text);
  padding: 9px 18px;
  font-size: 14px;
}
.btn-outline:hover { background: var(--bg); }

.error-box {
  display: none;
  background: var(--error-light);
  border: 1.5px solid #fca5a5;
  border-radius: 8px;
  padding: 14px 16px;
  font-size: 14px;
  color: var(--error);
  margin-top: 12px;
}
.error-box pre { font-size: 12px; margin-top: 8px; white-space: pre-wrap; color: var(--text-muted); }

@media (max-width: 520px) {
  .row { flex-direction: column; gap: 0; }
  .video-header { flex-direction: column; }
  .video-thumb { width: 100%; height: 160px; }
  .chapter-card { flex-direction: column; }
  .chapter-frame { width: 100%; height: 120px; }
}
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo">ğŸ¬</div>
    <div>
      <h1>VideoDigest</h1>
      <p>è¾“å…¥ YouTube é“¾æ¥ï¼ŒAI è‡ªåŠ¨æ€»ç»“è§†é¢‘è¦ç‚¹ + æå–å…³é”®æˆªå›¾</p>
    </div>
  </header>

  <div class="card" id="form-card">
    <div class="form-group">
      <label>YouTube è§†é¢‘é“¾æ¥</label>
      <input id="url-input" class="url-input" type="text"
             placeholder="https://www.youtube.com/watch?v=..."
             autocomplete="off" spellcheck="false">
    </div>

    <div class="row">
      <div class="form-group">
        <label>è¾“å‡ºè¯­è¨€</label>
        <select id="lang-select">
          <option value="Chinese" selected>ä¸­æ–‡</option>
          <option value="English">English</option>
          <option value="Japanese">æ—¥æœ¬èª</option>
          <option value="Korean">í•œêµ­ì–´</option>
        </select>
      </div>
      <div class="form-group">
        <label>æœ€å¤§æˆªå›¾æ•°</label>
        <select id="frames-select">
          <option value="0">ä¸æˆªå›¾ï¼ˆçº¯æ–‡å­—ï¼‰</option>
          <option value="6">6 å¼ </option>
          <option value="12" selected>12 å¼ </option>
          <option value="20">20 å¼ </option>
        </select>
      </div>
    </div>

    {% if not server_has_key %}
    <div class="form-group" id="key-group">
      <label>Anthropic API Key</label>
      <input id="api-key-input" type="password" placeholder="sk-ant-...">
      <p class="hint">Key ä»…ç”¨äºæœ¬æ¬¡è¯·æ±‚ï¼Œä¸ä¼šè¢«ä¿å­˜ã€‚</p>
    </div>
    {% endif %}

    <button class="btn btn-primary" id="analyze-btn" onclick="startAnalysis()">
      <span>ğŸš€</span> å¼€å§‹åˆ†æ
    </button>
  </div>

  <div class="card" id="progress-section">
    <div class="section-label">å¤„ç†è¿›åº¦</div>
    <div class="steps">
      <div class="step" id="step-fetch">
        <div class="step-icon">ğŸ“¡</div>
        <div class="step-body">
          <div class="step-name">è·å–è§†é¢‘ä¿¡æ¯</div>
          <div class="step-msg" id="msg-fetch">â€”</div>
        </div>
      </div>
      <div class="step" id="step-transcript">
        <div class="step-icon">ğŸ“</div>
        <div class="step-body">
          <div class="step-name">æå–å­—å¹• / è¯­éŸ³è½¬å½•</div>
          <div class="step-msg" id="msg-transcript">â€”</div>
        </div>
      </div>
      <div class="step" id="step-frames">
        <div class="step-icon">ğŸ–¼</div>
        <div class="step-body">
          <div class="step-name">æå–å…³é”®å¸§</div>
          <div class="step-msg" id="msg-frames">â€”</div>
        </div>
      </div>
      <div class="step" id="step-analyze">
        <div class="step-icon">ğŸ¤–</div>
        <div class="step-body">
          <div class="step-name">Claude AI åˆ†æ</div>
          <div class="step-msg" id="msg-analyze">â€”</div>
        </div>
      </div>
      <div class="step" id="step-output">
        <div class="step-icon">ğŸ’¾</div>
        <div class="step-body">
          <div class="step-name">ä¿å­˜æŠ¥å‘Š</div>
          <div class="step-msg" id="msg-output">â€”</div>
        </div>
      </div>
    </div>
    <div class="error-box" id="error-box">
      <strong>å‡ºé”™äº†</strong>
      <div id="error-msg"></div>
      <pre id="error-detail" style="display:none"></pre>
    </div>
  </div>

  <div id="result-section">

    <div class="card">
      <div class="video-header">
        <img class="video-thumb" id="res-thumb" src="" alt="thumbnail">
        <div class="video-meta">
          <div class="video-title" id="res-title"></div>
          <div class="video-info">
            <span id="res-channel"></span>
            <span id="res-duration"></span>
            <a id="res-link" href="#" target="_blank">â–¶ åœ¨ YouTube è§‚çœ‹</a>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-label">å†…å®¹æ¦‚è¿°</div>
      <div class="overview-text" id="res-overview"></div>
    </div>

    <div class="card">
      <div class="section-label">å…³é”®è¦ç‚¹</div>
      <ul class="key-points" id="res-keypoints"></ul>
    </div>

    <div class="card">
      <div class="section-label">ç« èŠ‚è¯¦æƒ…</div>
      <div class="chapters" id="res-chapters"></div>
    </div>

    <div class="action-bar">
      <button class="btn btn-outline" onclick="downloadJSON()">â¬‡ ä¸‹è½½ JSON</button>
      <button class="btn btn-outline" onclick="resetForm()">ğŸ”„ åˆ†ææ–°è§†é¢‘</button>
    </div>

  </div>

</div>

<script>
const SERVER_HAS_KEY = {{ server_has_key | tojson }};
let _lastResult = null;

function $(id) { return document.getElementById(id); }

function setStep(name, status, message) {
  const el = $(`step-${name}`);
  if (!el) return;
  el.className = `step ${status}`;
  const icons = { active: 'â³', done: 'âœ“', warn: 'âš ', skip: 'â€”', error: 'âœ—' };
  el.querySelector('.step-icon').textContent = icons[status] || 'â—‹';
  if (message) $(`msg-${name}`).textContent = message;
}

function showError(msg, detail) {
  const box = $('error-box');
  box.style.display = 'block';
  $('error-msg').textContent = msg;
  if (detail) {
    $('error-detail').textContent = detail;
    $('error-detail').style.display = 'block';
  }
  $('analyze-btn').disabled = false;
  $('analyze-btn').textContent = 'ğŸ”„ é‡è¯•';
}

async function startAnalysis() {
  const url = $('url-input').value.trim();
  if (!url) { $('url-input').focus(); return; }

  const apiKey = SERVER_HAS_KEY ? '' : ($('api-key-input')?.value.trim() || '');
  if (!SERVER_HAS_KEY && !apiKey) {
    $('api-key-input').focus();
    $('api-key-input').style.borderColor = 'var(--error)';
    return;
  }

  const maxFrames = parseInt($('frames-select').value);
  const lang = $('lang-select').value;

  $('analyze-btn').disabled = true;
  $('analyze-btn').innerHTML = '<span style="animation:spin 1s linear infinite;display:inline-block">â³</span> åˆ†æä¸­â€¦';
  $('progress-section').style.display = 'block';
  $('result-section').style.display = 'none';
  $('error-box').style.display = 'none';
  $('error-detail').style.display = 'none';
  ['fetch','transcript','frames','analyze','output'].forEach(s => setStep(s,'pending','â€”'));

  let jobId;
  try {
    const res = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, lang, api_key: apiKey, max_frames: maxFrames, no_frames: maxFrames === 0 }),
    });
    const data = await res.json();
    if (!res.ok) { showError(data.error || 'è¯·æ±‚å¤±è´¥'); return; }
    jobId = data.job_id;
  } catch(e) {
    showError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ' + e.message);
    return;
  }

  const es = new EventSource(`/api/stream/${jobId}`);
  es.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === 'step') {
      setStep(msg.step, msg.status, msg.message);
    } else if (msg.type === 'result') {
      es.close();
      _lastResult = msg.data;
      renderResult(msg.data);
      $('analyze-btn').disabled = false;
      $('analyze-btn').innerHTML = 'ğŸš€ å¼€å§‹åˆ†æ';
    } else if (msg.type === 'error') {
      es.close();
      showError(msg.message, msg.detail);
    } else if (msg.type === 'done') {
      es.close();
    }
  };
  es.onerror = () => {
    es.close();
    if (!_lastResult) showError('è¿æ¥ä¸­æ–­ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
  };
}

function renderResult(data) {
  $('res-thumb').src = data.thumbnail_url;
  $('res-title').textContent = data.title;
  $('res-channel').textContent = 'ğŸ“º ' + data.channel;
  $('res-duration').textContent = 'â± ' + data.duration_str;
  $('res-link').href = data.youtube_url;

  $('res-overview').textContent = data.overview;

  const kp = $('res-keypoints');
  kp.innerHTML = '';
  (data.key_points || []).forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    kp.appendChild(li);
  });

  const ch = $('res-chapters');
  ch.innerHTML = '';
  (data.chapters || []).forEach((c, i) => {
    const ytLink = `https://www.youtube.com/watch?v=${data.video_id}&t=${Math.floor(c.start_seconds)}s`;
    const frameHtml = c.frame_url
      ? `<img src="${c.frame_url}" alt="${c.title}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=no-frame>ğŸ–¼</div>'">`
      : `<div class="no-frame">ğŸ–¼</div>`;

    ch.innerHTML += `
      <div class="chapter-card">
        <div class="chapter-frame">${frameHtml}</div>
        <div class="chapter-body">
          <span class="chapter-ts">${c.timestamp}</span>
          <div class="chapter-title">
            <a href="${ytLink}" target="_blank" style="color:var(--text);text-decoration:none"
               onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text)'">
              ${c.title}
            </a>
          </div>
          <div class="chapter-summary">${c.summary}</div>
        </div>
      </div>`;
  });

  $('result-section').style.display = 'block';
  $('result-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function downloadJSON() {
  if (!_lastResult) return;
  const blob = new Blob([JSON.stringify(_lastResult, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${_lastResult.video_id || 'summary'}.json`;
  a.click();
}

function resetForm() {
  $('url-input').value = '';
  $('progress-section').style.display = 'none';
  $('result-section').style.display = 'none';
  $('error-box').style.display = 'none';
  $('analyze-btn').disabled = false;
  $('analyze-btn').innerHTML = 'ğŸš€ å¼€å§‹åˆ†æ';
  _lastResult = null;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

$('url-input').addEventListener('keydown', e => { if (e.key === 'Enter') startAnalysis(); });

const style = document.createElement('style');
style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
document.head.appendChild(style);
</script>
</body>
</html>
